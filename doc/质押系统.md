整体架构

  这是一个代理模式的DeFi收益聚合系统，分为两层：

  1. YieldProxy - 用户交互层（代理合约）
  2. AaveYieldStrategy - 策略执行层（具体实现）

  ---
  一、YieldProxy（收益代理合约）

  核心职责

  - 管理用户存款和份额
  - 处理收益分配和手续费
  - 支持策略切换
  - 提供统一的用户接口

  关键数据结构

  // 用户资金跟踪
  mapping(address => uint256) userDeposits;      // 用户总份额（包含本金+收益）
  mapping(address => uint256) userPrincipal;     // 用户本金
  uint256 totalDeposits;                          // 总份额
  uint256 totalPrincipal;                         // 总本金

  // 策略管理
  IYieldStrategy currentStrategy;                 // 当前活跃策略
  mapping(address => bool) authorizedStrategies; // 授权策略白名单

  核心功能流程

  1. 存款流程 (deposit) - contracts/YieldProxy.sol:68-89
  用户 → YieldProxy.deposit(amount)
    ├─ 从用户转入USDT
    ├─ 更新用户份额和本金
    ├─ 授权并调用 currentStrategy.deposit(amount)
    └─ Aave策略执行存款

  2. 取款流程 (withdraw) - contracts/YieldProxy.sol:95-120
  用户 → YieldProxy.withdraw(amount)
    ├─ 先调用 _claimYield() 领取收益
    ├─ 计算本金占比并更新状态
    ├─ 调用 currentStrategy.withdraw(amount)
    └─ 转账给用户

  3. 收益领取流程 (_claimYield) - contracts/YieldProxy.sol:160-188
  计算逻辑：
    totalBalance = currentStrategy.getBalance()  // 策略中总余额
    userShare = (totalBalance * userDeposits[user]) / totalDeposits
    yieldAmount = userShare - userPrincipal[user]  // 收益 = 份额 - 本金
    
  手续费处理：
    fee = yieldAmount * 1% (100/10000)
    userYield = yieldAmount - fee
    totalFees += fee

  提取并转账给用户

  4. 策略切换流程 (switchStrategy) - contracts/YieldProxy.sol:261-282
  管理员 → switchStrategy(newStrategy)
    ├─ 验证新策略已授权
    ├─ 从旧策略提取所有资金
    ├─ 授权新策略使用资金
    ├─ 更新 currentStrategy
    └─ 记录策略历史

  ---
  二、AaveYieldStrategy（Aave策略合约）

  核心职责

  - 与Aave协议交互
  - 管理aToken（计息代币）
  - 处理Aave奖励代币
  - 提供APR数据

  关键组件

  IERC20 assetToken;                    // 底层资产（如USDT）
  IAToken aToken;                        // Aave计息代币
  IAaveLendingPool lendingPool;         // Aave借贷池
  IAaveIncentivesController incentivesController; // 奖励控制器

  核心功能实现

  1. 存款到Aave (deposit) - contracts/strategies/AaveYieldStrategy.sol:85-100
  YieldProxy → AaveYieldStrategy.deposit(amount)
    ├─ 从YieldProxy接收USDT
    ├─ 授权Aave LendingPool使用USDT
    └─ lendingPool.deposit() → 获得aToken（自动产生收益）

  2. 从Aave提取 (withdraw) - contracts/strategies/AaveYieldStrategy.sol:105-114
  YieldProxy → AaveYieldStrategy.withdraw(amount)
    └─ lendingPool.withdraw() → 直接转给YieldProxy
       (aToken自动销毁，返回USDT)

  3. 余额查询 (getBalance) - contracts/strategies/AaveYieldStrategy.sol:134-136
  return aToken.balanceOf(address(this));
  // aToken余额会自动增长，代表本金+收益

  4. 奖励领取 (getRewards) - contracts/strategies/AaveYieldStrategy.sol:155-167
  领取Aave的额外激励代币（如stkAAVE）
    └─ incentivesController.claimRewards() → 转给调用者

  ---
  三、完整交互流程示例

  用户存款并获取收益流程

  1. 用户存入1000 USDT
     User → YieldProxy.deposit(1000)
       ├─ YieldProxy记录：userPrincipal[user] = 1000
       ├─ YieldProxy记录：userDeposits[user] = 1000
       └─ AaveYieldStrategy.deposit(1000)
            └─ Aave返回1000 aUSDT（开始计息）

  2. 一段时间后（假设产生50 USDT收益）
     aToken余额变为 1050 USDT

  3. 用户查询收益
     getUserEstimatedYield(user):
       totalBalance = 1050 (aToken余额)
       userShare = 1050 (只有该用户)
       yield = 1050 - 1000 = 50 USDT

  4. 用户领取收益
     User → claimYield()
       ├─ 计算收益：50 USDT
       ├─ 扣除1%手续费：fee = 0.5, userYield = 49.5
       ├─ AaveYieldStrategy.withdraw(49.5)
       ├─ 从Aave提取49.5 USDT
       └─ 转账给用户

     totalFees += 0.5 (累计给管理员)

  ---
  四、关键设计亮点

  1. 策略模式 - 可插拔设计

  - YieldProxy通过IYieldStrategy接口与策略交互
  - 可随时切换到其他收益策略（Compound、Curve等）
  - 策略白名单机制保证安全

  2. 收益计算方式

  采用份额制：
  - userShare = (totalBalance * userDeposits) / totalDeposits
  - 类似LP代币机制，自动按比例分配收益

  3. 手续费机制

  - 只对收益部分收取1%手续费
  - 本金不收费
  - 手续费累计到totalFees，管理员可提取

  4. 安全措施

  - nonReentrant 防止重入攻击
  - onlyValidStrategy 确保策略已激活且授权
  - SafeERC20 安全转账
  - 紧急提取函数应对异常

  ---